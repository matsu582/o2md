# Word/Excel図形のMermaid記法変換 実現可能性調査レポート

**調査日**: 2025-10-14  
**対象リポジトリ**: matsu582/o2md  
**調査目的**: Office文書（Word/Excel）に含まれる図形をMermaid記法に変換可能かどうかを検証する

---

## エグゼクティブサマリー

Office文書内の図形をMermaid記法に変換することは、**理論的には可能だが、実用化には多大な開発コストと技術的課題がある**という結論に達しました。

### 主要な発見事項

1. **現状のo2mdシステム**: 図形を画像（PNG）として出力している
2. **Mermaidの表現力**: フローチャート、シーケンス図、ER図など12種類以上の図をサポート
3. **技術的障壁**: 図形の意味理解とMermaid構文への変換に高度な実装が必要
4. **現実的な対応策**: 段階的アプローチとハイブリッド方式を推奨

---

## 1. 現状分析：o2mdシステムの図形処理

### 1.1 Excelファイルの図形処理

調査したサンプルファイル（five_sheet_.xlsx）の図形要素：

| 要素タイプ | 個数 | 説明 |
|-----------|------|------|
| グループ化された図形 (grpSp) | 10個 | 複数の図形がグループ化されたもの |
| 個別の図形 (sp) | 42個 | 矩形、角丸矩形、台形など |
| コネクタ (cxnSp) | 10個 | 図形間を接続する矢印 |
| 画像 (pic) | 3個 | 埋め込まれた画像ファイル |

検出された図形の種類：
- rect（矩形）: 15個
- roundRect（角丸矩形）: 12個
- trapezoid（台形）: 8個
- rightArrow（右矢印）: 2個
- triangle（三角形）: 2個
- その他（吹き出し、中括弧など）

図形内テキストの例：
- "ASTM、EQCメール受信ディレクトリ"
- "メール振り分け機能"
- "データ受付バッチ機能"

### 1.2 現在の処理フロー

現状のシステムは以下のフローで図形を処理しています：

```
Excelファイル → 図形クラスタリング → 個別グループレンダリング 
→ LibreOffice でPDF化 → ImageMagick でPNG化 → Markdownに画像として埋め込み
```

**重要な発見**: 図形の構造情報やテキスト内容は既にXMLから抽出可能な状態にあります。

---

## 2. Mermaid記法の表現能力

Mermaidがサポートする図形タイプ：

| 図形タイプ | Mermaid対応 | 用途 |
|-----------|------------|------|
| フローチャート | ✅ graph/flowchart | プロセスフロー、業務フロー |
| シーケンス図 | ✅ sequenceDiagram | システム間通信 |
| クラス図 | ✅ classDiagram | オブジェクト設計 |
| 状態図 | ✅ stateDiagram-v2 | 状態遷移 |
| ER図 | ✅ erDiagram | データベース設計 |
| ガントチャート | ✅ gantt | プロジェクト計画 |
| パイチャート | ✅ pie | データ分布 |
| マインドマップ | ✅ mindmap | 思考整理、階層構造 |
| タイムライン | ✅ timeline | 時系列イベント |

### Office図形とMermaidの対応関係

| Office図形 | Mermaid記法 | 対応状況 |
|-----------|------------|---------|
| 矩形 (rect) | `[テキスト]` | ✅ 対応可能 |
| 角丸矩形 (roundRect) | `(テキスト)` | ✅ 対応可能 |
| 菱形 | `{テキスト}` | ✅ 対応可能 |
| 台形 (trapezoid) | `{/テキスト/}` | ✅ 対応可能 |
| 三角形 | - | ⚠️ 直接サポートなし |
| 右矢印 | コネクタとして処理 | ⚠️ 要変換 |
| 吹き出し | - | ⚠️ 直接サポートなし |

---

## 3. 技術的課題と実現可能性評価

### 3.1 変換に必要な処理ステップ

```
1. 図形のXML解析         → ✅ 現在実装済み
2. 図形タイプの識別       → ✅ 部分的に実装済み
3. 図形内テキストの抽出    → ✅ XMLから抽出可能
4. 図形間の接続関係の解析  → ⚠️ コネクタ情報の意味理解が必要
5. 図の種類の推定        → ❌ 新規実装が必要
6. レイアウト情報の解析    → ⚠️ 座標からフロー方向を推定
7. Mermaid構文への変換   → ❌ 新規実装が必要
8. 構文の検証           → ❌ 新規実装が必要
```

### 3.2 主要な技術的課題

#### 課題1: 図の種類の自動判定

Office図形は「意味情報」を持たないため、パターンから図の種類を推定する必要があります：

- 矩形+菱形+矢印 → フローチャート？
- 横一列の矩形+縦矢印 → シーケンス図？
- カラス足接続 → ER図？

#### 課題2: レイアウト情報の解釈

Mermaidは方向性（TD, LR, BT, RL）を持ちますが、Office図形は自由配置。座標情報から配置パターンを分析し、適切なフロー方向を決定する必要があります。

#### 課題3: コネクタの意味理解

コネクタのスタイル（実線/点線/太線）と矢印の向きをMermaid記法にマッピングする必要があります：
- → (実線矢印)
- -.-> (点線矢印)
- ==> (太線矢印)

#### 課題4: 複雑な図形のフォールバック

Mermaidで表現できない図形：
- 自由形状の図形
- 複雑なグラフィック装飾
- 埋め込まれた画像
- 3D効果

### 3.3 実現可能性の評価

| 評価項目 | スコア | 説明 |
|---------|-------|------|
| 技術的実現可能性 | ⭐⭐⭐☆☆ (3/5) | 基本的な変換は可能だが高精度には課題 |
| 開発コスト | 高（3〜6ヶ月） | 新規実装が多数必要 |
| メンテナンスコスト | 中〜高 | ルールベースの調整が継続的に必要 |
| 精度・信頼性 | ⭐⭐☆☆☆ (2/5) | 誤変換のリスクが高い |
| ユーザーメリット | ⭐⭐⭐⭐☆ (4/5) | 成功すれば編集可能な図が得られる |

---

## 4. 推奨される実装アプローチ

### 4.1 段階的実装戦略

#### フェーズ1: 基礎分析機能（1〜2ヶ月）
- 図形情報をJSON形式で抽出
- デバッグ用の図形構造可視化

#### フェーズ2: シンプルなフローチャート変換（1〜2ヶ月）
- 矩形、菱形、矢印のみの図を対象
- 接続関係が明確な図のみ変換
- 変換成功率のレポート機能

#### フェーズ3: 図の種類判定の高度化（2〜3ヶ月）
- シーケンス図、ER図などへ対応拡大
- パターンマッチングによる判定

#### フェーズ4: AI/ML統合（オプション、3〜6ヶ月）
- 画像認識モデルでの図の種類分類
- 高精度な変換

### 4.2 推奨されるハイブリッドアプローチ

```markdown
## システムフロー（Mermaid変換成功）

\`\`\`mermaid
graph TD
    A[開始] --> B{判定}
    B -->|Yes| C[処理1]
    B -->|No| D[処理2]
\`\`\`

## 複雑な構成図（画像出力）

![システム構成図](images/architecture_001.png)

<!--  
図形メタデータ:
- 図形数: 15
- コネクタ数: 10
- 主要要素: メール受信、振り分け機能、データ受付
-->
```

メリット：
1. 画像出力は現状通り動作（リスク低）
2. シンプルな図から順次Mermaid化（段階的改善）
3. 誤変換時も画像がバックアップとして残る
4. 変換品質に応じてユーザーが選択可能

---

## 5. 代替案の検討

### 5.1 手動アノテーション方式

Excelセル内にコメントで図の種類を明示：
```
"@mermaid:flowchart:TD"
```

### 5.2 専用エディタへのリンク提供

```markdown
![フロー図](images/flow_001.png)

[この図をMermaidで編集](https://mermaid.live/edit#...)
```

### 5.3 AIアシスタント統合

LLMを活用して画像とメタデータからMermaidコードを生成。

---

## 6. 結論と推奨事項

### 6.1 総合評価

**Mermaid変換の実現可能性**: ⭐⭐⭐☆☆ (中程度)

Word/Excel図形のMermaid変換は技術的には可能ですが、**段階的かつ限定的なアプローチを推奨**します。

理由：
1. 完全自動化は困難（図の意味理解が必要）
2. 開発コストが高い（3〜6ヶ月の開発期間）
3. 精度の保証が難しい（ユーザーの確認作業が必須）
4. メンテナンスコストが継続的に発生

### 6.2 推奨実装計画

#### 短期（1〜2ヶ月）
- ✅ 図形メタデータ抽出機能
- ✅ JSON/コメント形式での出力
- ✅ 手動Mermaid変換を支援する形式提供

#### 中期（3〜4ヶ月）
- ✅ シンプルなフローチャート自動変換
- ✅ ハイブリッド出力（Mermaid + 画像）
- ✅ 変換成功率レポート

#### 長期（6ヶ月以降）
- ⚠️ シーケンス図、ER図への対応拡大
- ⚠️ AI/ML判定精度向上（オプション）
- ⚠️ フィードバックに基づく継続的改善

### 6.3 即座に実装可能な改善案

図形メタデータをMarkdown コメントとして出力：

```markdown
![システムフロー](images/flow_001.png)

<!--
図形情報（Mermaid変換時の参考）:
{
  "shapes": [
    {"type": "rect", "text": "開始", "position": {"row": 5, "col": 2}},
    {"type": "diamond", "text": "判定", "position": {"row": 8, "col": 2}}
  ],
  "connectors": [
    {"from": 0, "to": 1, "type": "arrow"}
  ],
  "suggested_type": "flowchart"
}
-->
```

---

## 7. 参考情報

### 7.1 関連技術

- 図形解析: openpyxl, python-docx, lxml
- 画像処理: Pillow, LibreOffice, ImageMagick
- Mermaid: mermaid.js, mermaid-cli
- AI/ML (オプション): TensorFlow, PyTorch, OpenAI API

### 7.2 類似プロジェクト

- PlantUML: テキストベースのUML図生成
- Diagrams: Pythonコードで図を生成
- draw.io: XML形式（一部Mermaid変換可能）

### 7.3 参考リンク

- [Mermaid公式ドキュメント](https://mermaid.js.org/)
- [Office Open XML仕様](https://learn.microsoft.com/en-us/openspecs/office_standards/ms-oi29500/)
- [DrawingML仕様](https://learn.microsoft.com/en-us/openspecs/office_standards/ms-odrawxml/)

---

## 付録: 開発工数見積もり

| フェーズ | 作業内容 | 工数（人月） | リスク |
|---------|---------|------------|--------|
| フェーズ1 | 図形メタデータ抽出 | 1.0 | 低 |
| フェーズ2 | シンプルなフローチャート変換 | 1.5 | 中 |
| フェーズ3 | 多様な図タイプ対応 | 2.0 | 高 |
| フェーズ4 | AI/ML統合（オプション） | 3.0 | 高 |
| テスト・デバッグ | - | 0.5 | 中 |
| ドキュメント作成 | - | 0.5 | 低 |
| **合計** | - | **8.5** | - |

**注**: 1名のフルタイム開発者を想定した見積もりです。

---

## 改訂履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|----------|---------|--------|
| 2025-10-14 | 1.0 | 初版作成 | Devin AI |
